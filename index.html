<!DOCTYPE HTML>
<html>
<head>
  <script>

    var gChartList = [];

    function requestfile(iLocalFilePath, oCallback) {
      const Http = new XMLHttpRequest();
      const url = iLocalFilePath;
      // const url = './db_generated/USAPopulationSummary.csv';
      Http.open("GET", url);
      Http.send();
      Http.onreadystatechange = (e) => {
        
        dom = document.getElementById("textDisplay")
        dom.innerText = Http.responseText
        if ("" != Http.responseText) {
          oCallback(Http.responseText);
        }
      }
    }

    function parseCSVtoDataset(iCSVString) {
      if ("" == iCSVString) {
        return [];
      }

      var wLines = iCSVString.split('\n');

      if (0 == wLines) {
        return [];
      }

      var wLineList = [];
      var wHeader = wLines[0].split(',');

      for (var i = 0; i < wHeader.length; ++i) {
        wLineList.push({ mName: wHeader[i], mData: [] });
      }

      for (var i = 1; i < wLines.length; ++i) {
        var wRow = wLines[i].split(',');

        for (var j = 0; j < wRow.length && j < wLineList.length; ++j) {
          wLineList[j].mData.push(wRow[j]);
        }
      }

      return wLineList
    }


    function createLineObject(iLineName, iData) {
      return {
        type: "line",
        name: iLineName,
        showInLegend: true,
        markerSize: 2,
        dataPoints: iData
      };
    }

    function createChart_XYear_YCount(iDivContainerID, iTitle, iDataset, iXAxisIndex, iYAxisIndex) {

      wDataSet = [];
      for (var i = 0; i < iDataset.length; ++i) {
        if (iXAxisIndex != i) {
          var wSkip = true;
          for (var k = 0; k < iYAxisIndex.length; ++k) {
            if (iYAxisIndex[k] == i) {
              wSkip = false;
              break;
            }
          }

          if (true == wSkip) {
            continue;
          }
          wPointList = [];
          wXData = iDataset[iXAxisIndex].mData;
          wYData = iDataset[i].mData;
          for (var k = 0; k < wYData.length; ++k) {
            if (iXAxisIndex)
              wPointList.push({ x: new Date(wXData[k], 01, 01), y: wYData[k] });
          }
          wDataSet.push(createLineObject(iDataset.mName, wPointList));

        }
      }

      var wChart = new CanvasJS.Chart(iDivContainerID, {
        title: {
          text: iTitle
        },
        axisX: {
          title: "Year",
          valueFormatString: "YYYY"
        },
        axisY: {
          title: "Population Count",
        },
        toolTip: {
          shared: true
        },
        legend: {
          cursor: "pointer",
          verticalAlign: "top",
          horizontalAlign: "center",
          dockInsidePlotArea: true,
          itemclick: toogleDataSeries
        },
        data: wDataSet
      });
      wChart.render();
      gChartList.push(chart);
      return chart;
    }

    function toogleDataSeries(e) {
      if (typeof (e.dataSeries.visible) === "undefined" || e.dataSeries.visible) {
        e.dataSeries.visible = false;
      } else {
        e.dataSeries.visible = true;
      }
      for (var i = 0; i < gChartList.length; ++i) {
        gChartList.render();
      }
    }


    window.onload = function () {
      requestfile("./db_generated/USAPopulationSummary.csv", function (iCSVString) {
        wLineList = parseCSVtoDataset(iCSVString);
        wChart = createChart_XYear_YCount(chartContainer, "USA Social Security Issued per Year", wLineList, 1, [2, 5]);
      })

    }

  </script>
</head>
<body>
  <textarea id="textDisplay"></textarea>
  <div id="chartContainer" style="height: 370px; width: 100%;"></div>
  <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
</body>
</html>